## Основные требования
 - Время реализации - не более 3-4х часов
 - Допускается использование любых вспомогательных библиотек, которые не реализуют данную задачу
 

### Опциональные требования
 - Покрытие тестами


### Техническое описание

Разработать консольную утилиту для деплоя PHP приложений. В случае “неудачного деплоя”  утилита должна иметь функционал быстро (это важно) “вернуть все как было”.Предполагается, что приложение общается с реляционной базой данных (any), использует php-fpm и nginx. Также, приложение использует memcached (если это важно). 

Разрешается использовать любой защищенный протокол общения с сервером, имеющий opensource реализации.

Утилита может накладывать дополнительные ограничения на релизы, например, запрещать необратимые изменения базы данных и т.д. Также, можно наложить дополнительные требования к коду (например, список зависимостей в каком-то виде или прочую информацию об артефактах или интеграцию с системами сборки артефактов).

Для своей работы утилита может использовать дополнительные ресурсы целевого сервера (RAM, Storage, CPU) (в разумных пределах, конечно).

Все ограничения и требования необходимо описать в свободном формате.

### Будет плюсом:

Если “что-то пошло не так” утилита, по возможности, не должна бросать целевой сервер в неопределенно-рабочем состоянии, в разумных пределах (очевидно, от всех бед защититься невозможно).


## Реализация

### Требования
На локальном сервере сервере установлено:
- Linux
- zip
- composer (global)
- git
- проект который необходимо задеплоить склонирован в папку указанную в config/config.php ({workingDir}/{appDir}) 

На удаленном сервере установлено:
- Linux
- unzip
- composer (gloabl)
- php-fpm
- nginx сконфигурирован на папку укзанную в config.php ({destinationDir}/current)
- пользователь с правами на запись в /tmp, destinationDir и правами на перезапуск php-fpm

### Установка
composer install

### Использование
Чтобы выполнить деплой
php ./bin/deploy.php --command=deploy --appVersion={version}
e.g.
php ./bin/deploy.php --command=deploy --appVersion=v4.0.5

Чтобы откатить до конкректной версии ранее задеплоеной на целевой сервер
php ./bin/deploy.php --command=rollback --deployId={deployId}
e.g.
php ./bin/deploy.php --command=rollback --deployId=5aa44ba020940

### Детали реализация
Делпой проводится в три фазы.
- prepare - делает checkout переданного тега (appVersion)
- transfer - делает zip, scp, unzip проекта на целевой сервер.
- install - выполняет composer install, изменение симлинка на новую версию, reload php-fpm чтобы использовать новую папку.

Rollback делает изменение симлинка на переданную версию, reload php-fpm чтобы использовать новую папку.

Фактически приложение может выполнять консольные команды как локально так и на целевом сервере. Таким образом для миграции базы будет достаточно добавить соответсвующую команду в install (к примеру "console migrations:migrate" для Symfony). Так же можно перезапустить memcached если это требуется.

composer install находится в фазе install т.к. в момент сборки могут быть выпонены дополнительные команды такие как создание симлинок. Если такие команды не требуются можно перенести "composer install" в фазу prepare.

### Ограничения

- при неудачном деплое вебсервер все равно будет переключен на новую версию приложения. (нет проверок если какая то команда выполнилась с ошибкой)
- при неудачном деплое мусор остается на сервере (нужно для каждой фазы описать процесс rollback'а)
- старые сборки не удаляются. каждый билд создает новую папку.
- в zip архив попадает папка .git, что может значительно увеличить размеры (лечится правильными фильтрами на команду архивации)
